name: Deploy to Development

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        python test_ci.py
      env:
        PYTHONPATH: ${{ github.workspace }}

  deploy-dev:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Ansible
      run: |
        sudo apt-get update
        sudo apt-get install -y ansible
    
    - name: Deploy to Development
      env:
        ANSIBLE_HOST_KEY_CHECKING: False
        VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      run: |
        echo "Debug: VAULT_PASSWORD length: ${#VAULT_PASSWORD}"
        echo "Debug: VAULT_PASSWORD starts with: ${VAULT_PASSWORD:0:10}..."
        echo "$VAULT_PASSWORD" > vault_pass.txt
        echo "Debug: vault_pass.txt contents:"
        cat vault_pass.txt
        ansible-playbook \
          --vault-password-file vault_pass.txt \
          -u ansible \
          --private-key ~/.ssh/keys/nirdclub__id_ed25519 \
          -i ansible/inventory.yml \
          -e "deploy_path=/opt/hampuff-sms-dev" \
          -e "app_environment=development" \
          ansible/main.yml
        rm vault_pass.txt
